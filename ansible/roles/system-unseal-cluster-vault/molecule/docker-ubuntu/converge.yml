---
# Данный файл используется для преобразования состояния экземпляров в реальное состояние, объявленное в реальных тестируемых ролях:
- name: Converge
  hosts: all
  gather_facts: true
  tasks:
    # Данный шаг вызывает роль manual-cluster-vault для последующего прогона system-unseal-cluster-vault:
    - name: "Include manual-cluster-vault role for testing"
      include_role:
        name: "manual-cluster-vault"

    # Добавление интервала по времени для загрузки Vault:
    - name: "Wait 10 second for checking Vault"
      wait_for:
        timeout: 10

    # Данный шаг вызывает роль system-unseal-cluster-vault для прогона тестов с помощью Molecule:
    - name: "Include system-unseal-cluster-vault role for testing"
      include_role:
        name: "system-unseal-cluster-vault"

# Тестирование повторного распечатывания Vault кластера после перезапуска (re-unseal сценарий):
- name: Re-unseal Vault cluster after restart
  hosts: all
  gather_facts: true
  tasks:
    # Перезапуск сервиса Vault для перевода его в sealed состояние (503):
    - name: "Restart Vault service to simulate sealed state"
      systemd:
        name: vault
        state: restarted
      changed_when: false

    # Добавление интервала по времени для загрузки Vault:
    - name: "Wait 10 second for Vault to start in sealed state"
      wait_for:
        timeout: 10

    # Повторный вызов роли system-unseal-cluster-vault для проверки re-unseal сценария:
    - name: "Include system-unseal-cluster-vault role for re-unseal testing"
      include_role:
        name: "system-unseal-cluster-vault"
