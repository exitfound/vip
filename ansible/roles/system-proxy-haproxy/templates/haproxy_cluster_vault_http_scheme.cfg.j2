{% set _domain_id = global_haproxy_host_domain | replace('.', '_') | replace('-', '_') %}
{% set _ssl = ' ssl verify none' if global_haproxy_set_proxy_pass_scheme | default('http') == 'https' else '' %}
{% if global_haproxy_set_http_scheme == 'http' %}
frontend f_{{ _domain_id }}
    bind *:80
    acl acl_{{ _domain_id }} hdr(host) -i {{ global_haproxy_host_domain }}
    use_backend b_{{ _domain_id }} if acl_{{ _domain_id }}

backend b_{{ _domain_id }}
    balance first
    option httpchk GET /v1/sys/health
    http-check expect rstatus (200|429|472|473)
{% for ip in global_haproxy_set_cluster_vault_addresses %}
    server vault{{ loop.index }} {{ ip }}:{{ global_vault_host_listening_port }} check{{ _ssl }}
{% endfor %}

{% elif global_haproxy_set_http_scheme == 'https' %}
frontend f_{{ _domain_id }}_redirect
    bind *:80
    mode http
    http-request redirect scheme https code 301

frontend f_{{ _domain_id }}_https
    bind *:443 ssl crt {{ local_system_haproxy_dir_ssl }}/{{ global_haproxy_host_domain }}.pem alpn h2,http/1.1
    acl acl_{{ _domain_id }} hdr(host) -i {{ global_haproxy_host_domain }}
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Real-IP %[src]
    use_backend b_{{ _domain_id }} if acl_{{ _domain_id }}

backend b_{{ _domain_id }}
    balance first
    option httpchk GET /v1/sys/health
    http-check expect rstatus (200|429|472|473)
{% for ip in global_haproxy_set_cluster_vault_addresses %}
    server vault{{ loop.index }} {{ ip }}:{{ global_vault_host_listening_port }} check{{ _ssl }}
{% endfor %}

{% else %}
# Fallback: default to http
frontend f_{{ _domain_id }}_fallback
    bind *:80
    default_backend b_{{ _domain_id }}_fallback

backend b_{{ _domain_id }}_fallback
    server vault 127.0.0.1:{{ global_vault_host_listening_port }} check

{% endif %}
