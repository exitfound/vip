{% if global_haproxy_set_http_scheme == 'http' %}
frontend f_cluster_vault
    bind *:80
    acl acl_cluster_vault hdr(host) -i {{ global_haproxy_host_domain }}
    use_backend b_cluster_vault if acl_cluster_vault

backend b_cluster_vault
    balance first
    option httpchk GET /v1/sys/health
    http-check expect status 200
{% for ip in global_haproxy_set_cluster_vault_addresses %}
    server vault{{ loop.index }} {{ ip }}:{{ global_vault_host_listening_port }} check
{% endfor %}

{% elif global_haproxy_set_http_scheme == 'https' %}
frontend f_cluster_vault_redirect
    bind *:80
    mode http
    http-request redirect scheme https code 301

frontend f_cluster_vault_https
    bind *:443 ssl crt {{ local_system_haproxy_dir_ssl }}/{{ global_haproxy_host_domain }}.pem alpn h2,http/1.1
    acl acl_cluster_vault hdr(host) -i {{ global_haproxy_host_domain }}
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Real-IP %[src]
    use_backend b_cluster_vault if acl_cluster_vault

backend b_cluster_vault
    balance first
    option httpchk GET /v1/sys/health
    http-check expect status 200
{% for ip in global_haproxy_set_cluster_vault_addresses %}
    server vault{{ loop.index }} {{ ip }}:{{ global_vault_host_listening_port }} check
{% endfor %}

{% else %}
# Fallback: default to http
frontend http_front
    bind *:80
    default_backend http_back

backend http_back
    server vault 127.0.0.1:{{ global_vault_host_listening_port }} check

{% endif %}
