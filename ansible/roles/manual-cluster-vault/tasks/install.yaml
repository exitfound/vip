---
# Проверка корректности комбинации storage backend переменных:
- name: Validate storage backend configuration on Linux distro
  assert:
    that:
      - global_vault_cluster_enable_raft != global_vault_cluster_enable_consul
    fail_msg: >-
      Invalid storage backend configuration:
      global_vault_cluster_enable_raft={{ global_vault_cluster_enable_raft }},
      global_vault_cluster_enable_consul={{ global_vault_cluster_enable_consul }}.
      Exactly one must be true.

# Вызов предварительной роли system-internal-certificates для полноценного запуска текущей роли в рамках заданных условий:
- name: Import system-internal-certificates role for running current role on Linux distro
  import_role:
    name: system-internal-certificates
    tasks_from: main
  when: global_vault_cluster_enable_https | bool

# Определение пути к Systemd unit файлу в зависимости от дистрибутива:
- name: Set systemd unit path based on distribution
  set_fact:
    local_vault_manual_cluster_systemd_path: >-
      {{ '/etc/systemd/system'
         if (ansible_distribution == 'Debian' and ansible_distribution_major_version | int < 12)
         else '/usr/lib/systemd/system' }}

# Создание группы с именем Vault:
- name: Create Vault Cluster group on Linux distro
  group:
    name: "{{ local_vault_manual_cluster_group }}"
    gid: "{{ local_vault_manual_cluster_group_id }}"
    state: present

# Создание пользователя с именем Vault:
- name: Create Vault Cluster user on Linux distro
  user:
    name: "{{ local_vault_manual_cluster_user }}"
    groups: "{{ local_vault_manual_cluster_group }}"
    uid: "{{ local_vault_manual_cluster_user_id }}"
    home: "{{ local_vault_manual_cluster_dir_data }}"
    shell: /sbin/nologin
    append: true

# Вызов предварительной задачи consul-ca-tls.yaml для полноценного завершения текущей роли в рамках заданных условий:
- name: Import Consul CA task for running current role on Linux distro
  include_tasks: consul-ca-tls.yaml
  when: global_vault_cluster_enable_consul and global_vault_cluster_enable_consul_https | bool

# Создание нескольких директорий для последующей работы с кластером Vault:
- name: Create Vault Cluster directories on Linux distro
  file:
    state: directory
    path: "{{ item.path }}"
    mode: "{{ local_vault_manual_cluster_dir_mode }}"
    owner: "{{ local_vault_manual_cluster_user }}"
    group: "{{ local_vault_manual_cluster_group }}"
  loop:
    - {path: "{{ local_vault_manual_cluster_dir_config }}"}
    - {path: "{{ local_vault_manual_cluster_dir_data }}"}

# Проверка текущей установленной версии Vault:
- name: Check installed Vault Cluster version on Linux distro
  command: "{{ local_vault_manual_cluster_path_binary }}/vault version"
  register: vault_installed_version
  changed_when: false
  failed_when: false

# Загрузка архива с бинарным файлом Vault из Интернета по прямой ссылке:
- name: Download Vault Cluster archive for future installation on Linux distro
  get_url:
    url: "{{ local_vault_manual_cluster_file_archive_link }}"
    mode: "{{ local_vault_manual_cluster_file_mode }}"
    dest: "/tmp/{{ local_vault_manual_cluster_file_archive_name }}"
    checksum: "{{ global_vault_file_archive_checksum }}"
    force: false
  register: vault_download_result
  retries: 3
  delay: 5
  until: vault_download_result is success
  when: >
    vault_installed_version.rc != 0 or
    global_vault_current_version not in vault_installed_version.stdout

# Извлечение архива и перемещение бинарного файла в соответствующую директорию:
- name: Unpack the Vault Cluster archive and move the binary file on Linux distro
  unarchive:
    src: "/tmp/{{ local_vault_manual_cluster_file_archive_name }}"
    dest: "{{ local_vault_manual_cluster_path_binary }}"
    mode: "0755"
    remote_src: true
  when: >
    vault_installed_version.rc != 0 or
    global_vault_current_version not in vault_installed_version.stdout
  notify: Restart Vault Cluster

# Копирование всех конфигурационных файлов Vault и их последующая отправка в соответствующие директории:
- name: Copy Vault Cluster configuration files from templates on Linux distro
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default(local_vault_manual_cluster_file_mode) }}"
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
  loop:
    - src: "templates/{{ local_vault_manual_cluster_file_autocomplete_j2 }}"
      dest: "{{ local_vault_manual_cluster_file_autocomplete_path }}"
      mode: "{{ local_vault_manual_cluster_file_mode }}"
      owner: "{{ local_vault_manual_cluster_user }}"
      group: "{{ local_vault_manual_cluster_group }}"
    - src: "templates/{{ lookup('vars', global_vault_cluster_enable_https | ternary('global_vault_cluster_https_config', 'global_vault_cluster_http_config')) }}"
      dest: "{{ local_vault_manual_cluster_dir_config }}/{{ local_vault_manual_cluster_file_config }}"
      mode: "{{ local_vault_manual_cluster_file_mode }}"
      owner: "{{ local_vault_manual_cluster_user }}"
      group: "{{ local_vault_manual_cluster_group }}"
    - src: "templates/{{ local_vault_manual_cluster_file_systemd }}.j2"
      dest: "{{ local_vault_manual_cluster_systemd_path }}/{{ local_vault_manual_cluster_file_systemd }}"
      mode: "{{ local_vault_manual_cluster_file_mode }}"
      owner: "0"
      group: "0"
  notify: Restart Vault Cluster

# Запуск и добавление в автозагрузку сервиса Vault с помощью Systemd:
- name: Start Vault Cluster service on Linux distro
  systemd:
    name: vault
    state: started
    enabled: true
    daemon_reload: true

# Проверка того, что Vault Cluster отдаёт TLS-рукопожатие на Linux дистрибутиве:
- name: Check if Vault Cluster is serving TLS on Linux distro
  shell: openssl s_client -connect 127.0.0.1:{{ global_vault_host_listening_port }} < /dev/null 2>/dev/null
  register: vault_tls_check
  failed_when: false
  changed_when: false
  when: global_vault_cluster_enable_https | bool

# Перезапуск Vault Cluster если сертификаты были обновлены или TLS ещё не активен на Linux дистрибутиве:
- name: Restart Vault Cluster if TLS certificates were updated or TLS is not yet active on Linux distro
  systemd:
    name: vault
    state: restarted
  when:
    - global_vault_cluster_enable_https | bool
    - >-
      local_system_internal_node_cert_changed is changed or
      local_system_internal_ca_cert_changed is changed or
      vault_tls_check.rc != 0

# Применение всех накопленных хендлеров до выполнения проверки сертификата:
- meta: flush_handlers

# Проверка того, что сертификат был создан на запущенном узле:
- name: Check that the certificate has been added on Linux distro
  shell: |
    openssl s_client -connect 127.0.0.1:{{ global_vault_host_listening_port }} -CAfile {{ global_system_internal_dir_node_certificates }}/{{ global_system_internal_file_ca_certificate }} < /dev/null 2>/dev/null
  register: openssl_status_check
  until: "'Verification: OK' in openssl_status_check.stdout"
  retries: 5
  delay: 5
  failed_when: "'Verification: OK' not in openssl_status_check.stdout"
  changed_when: false
  when: global_vault_cluster_enable_https | bool

# Финальный вывод после проверки работоспособности сертификата:
- name: Output the result on Linux distro
  debug:
    msg: "{{ openssl_status_check.stdout }}"
  when: global_vault_cluster_enable_https | bool
